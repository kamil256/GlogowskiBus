@model GlogowskiBus.UI.Models.HomeBusPositionsViewModel

@{ 
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Autobusy i przystanki";
}

<div id="navigation" data-bind="visible: view() == 'Navigation'">
    <p>Pokaż/ukryj linie:</p>
    <ul id="busLinesTiles" data-bind="foreach: busLines">
        <li data-bind="click: function() { hidden(!hidden()); }, css: { active: !hidden() }, text: busNumber"></li>
    </ul>
    <p>
        <span class="textButton">Pokaż wszystkie</span> | <span class="textButton">Ukryj wszystkie</span>
    </p>
</div>

<div id="findRoute" data-bind="visible: view() == 'FindRoute'">
</div>

<div id="schedule" data-bind="visible: view() == 'Schedule'">
    <p>Przystanek:</p>
    <select class="form-control" data-bind="options: busStops, optionsText: 'name', optionsCaption: '-', value: busStops.activeBusStop"></select>
    <br />

    <!-- ko if: busStops.activeBusStop() -->
        <p>Linia:</p>
        <ul id="busLinesTiles" data-bind="foreach: busStops.activeBusStop().points">
            <li data-bind="click: function() { $root.busLines.selectedBusLine(route.busLine) }, css: { active: $root.busLines.selectedBusLine() == route.busLine }, text: route.busLine.busNumber"></li>
        </ul>
    <!-- /ko -->

    <!-- ko if: busStops.activeBusStop() && busLines.selectedBusLine() -->
        <ul><li>Dzień roboczy</li><li>Sobota</li><li>Niedziela</li></ul>
        @*<table data-bind="foreach: timeTable().busStops">
            <tr>
                <td data-bind="text: timeOffset"></td>
                <td data-bind="text: name"></td>
            </tr>
        </table>*@

        <table>
            <tr>
                <td>0</td>
                <!-- ko foreach: $root.timeTable().hours[0] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>1</td>
                <!-- ko foreach: $root.timeTable().hours[1] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>2</td>
                <!-- ko foreach: $root.timeTable().hours[2] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>3</td>
                <!-- ko foreach: $root.timeTable().hours[3] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>4</td>
                <!-- ko foreach: $root.timeTable().hours[4] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>5</td>
                <!-- ko foreach: $root.timeTable().hours[5] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>6</td>
                <!-- ko foreach: $root.timeTable().hours[6] -->
                <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>7</td>
                <!-- ko foreach: $root.timeTable().hours[7] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>8</td>
                <!-- ko foreach: $root.timeTable().hours[8] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>9</td>
                <!-- ko foreach: $root.timeTable().hours[9] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>10</td>
                <!-- ko foreach: $root.timeTable().hours[10] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>11</td>
                <!-- ko foreach: $root.timeTable().hours[11] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>12</td>
                <!-- ko foreach: $root.timeTable().hours[12] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>13</td>
                <!-- ko foreach: $root.timeTable().hours[13] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>14</td>
                <!-- ko foreach: $root.timeTable().hours[14] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>15</td>
                <!-- ko foreach: $root.timeTable().hours[15] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>16</td>
                <!-- ko foreach: $root.timeTable().hours[16] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>17</td>
                <!-- ko foreach: $root.timeTable().hours[17] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>18</td>
                <!-- ko foreach: $root.timeTable().hours[18] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>19</td>
                <!-- ko foreach: $root.timeTable().hours[19] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>20</td>
                <!-- ko foreach: $root.timeTable().hours[20] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>21</td>
                <!-- ko foreach: $root.timeTable().hours[21] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>22</td>
                <!-- ko foreach: $root.timeTable().hours[22] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
            <tr>
                <td>23</td>
                <!-- ko foreach: $root.timeTable().hours[23] -->
                    <td data-bind="text: $data"></td>
                <!-- /ko -->
            </tr>
        </table>
        
    <!-- /ko -->
</div>

<script>
    function ServerTime()
    {
        var self = this;

        var serverTime = Number(@Model.ServerTimeMilliseconds);

        var timeDifference = serverTime - new Date().getTime();

        self.now = function()
        {
            return new Date(new Date().getTime() + timeDifference);
        };
    }

    function getPositionBetweenTwoPoints(startPoint, endPoint, currentTimeOffset)
    {
        var latitudeDifference = endPoint.latitude - startPoint.latitude;
        var longitudeDifference = endPoint.longitude - startPoint.longitude;
        var timeRatio = (currentTimeOffset - startPoint.timeOffset) / (endPoint.timeOffset - startPoint.timeOffset);
        var newPointLatitude = startPoint.latitude + latitudeDifference * timeRatio;
        var newPointLongitude = startPoint.longitude + longitudeDifference * timeRatio;
        return new google.maps.LatLng(newPointLatitude, newPointLongitude);
    }

    window.onload = function()
    {
        serverTime = new ServerTime();
        markerIcons = new MarkerIcons();

        var context = new Context(@Html.Raw(Json.Encode(@Model.BusStops)), @Html.Raw(Json.Encode(@Model.BusLines)));
        ko.applyBindings(context);

        map.addListener('click', function(e)
        {
            context.busStops.activeBusStop(null);
            context.busLines.selectedBusLine(null);
        });
    }
</script>