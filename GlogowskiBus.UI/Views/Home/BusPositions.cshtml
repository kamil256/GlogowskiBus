@model GlogowskiBus.UI.Models.HomeBusPositionsViewModel

@{ 
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Autobusy i przystanki";
}

<div id="navigation" data-bind="visible: view() == 'Navigation'">
    <p>Pokaż/ukryj linie:</p>
    <ul id="busLinesTiles" data-bind="foreach: busLines">
        <li data-bind="click: function() { hidden(!hidden()); }, css: { active: !hidden() }, text: busNumber"></li>
    </ul>
    <p>
        <span class="textButton">Pokaż wszystkie</span> | <span class="textButton">Ukryj wszystkie</span>
    </p>
</div>

<div id="findRoute" data-bind="visible: view() == 'FindRoute'">
</div>

<div id="timeTable" data-bind="visible: view() == 'TimeTable'">
    <p>Przystanek:</p>
    <select class="form-control" data-bind="options: busStops, optionsText: 'name', optionsCaption: '-', value: busStops.activeBusStop"></select>
    <br />

    <!-- ko if: busStops.activeBusStop() -->
    <p>Linia:</p>
    <ul id="busLinesTiles" data-bind="foreach: busStops.activeBusStop().points">
        <li data-bind="click: function() { $root.busLines.selectedBusLine(route.busLine) }, css: { active: $root.busLines.selectedBusLine() == route.busLine }, text: route.busLine.busNumber"></li>
    </ul>
    <!-- /ko -->

    <!-- ko if: busStops.activeBusStop() && busLines.selectedBusLine() -->
    <ul class="dayOfWeek">
        <li>Dzień roboczy</li>
        <li>Sobota</li>
        <li>Niedziela</li>
    </ul>
        
    <table class="busStops" data-bind="foreach: timeTable().busStops">
        <tr>
            <td data-bind="text: name"></td>
            <td data-bind="text: timeOffset"></td>
        </tr>
    </table>

    <table class="departureTimes">
        <tr>
            <td>

            </td>
            <td>
                Dzień roboczy
            </td>
            <td>
                Sobota
            </td>
            <td>
                Niedziela
            </td>
        </tr>
        <!-- ko foreach: timeTable().hours -->
        <tr>
            <td data-bind="text: $index"></td>
            <td>
                <!-- ko foreach: $root.timeTable().hours[$index()] -->
                    <span data-bind="text: $data"></span>
                <!-- /ko -->
            </td>

            <td>
                <!-- ko foreach: $root.timeTable().hours[$index()] -->
                <span data-bind="text: $data"></span>
                <!-- /ko -->
            </td>

            <td>
                <!-- ko foreach: $root.timeTable().hours[$index()] -->
                <span data-bind="text: $data"></span>
                <!-- /ko -->
            </td>
        </tr>
        <!-- /ko -->
    </table>

    <!-- /ko -->
</div>

<script>
    function ServerTime()
    {
        var self = this;

        var serverTime = Number(@Model.ServerTimeMilliseconds);

        var timeDifference = serverTime - new Date().getTime();

        self.now = function()
        {
            return new Date(new Date().getTime() + timeDifference);
        };
    }

    function getPositionBetweenTwoPoints(startPoint, endPoint, currentTimeOffset)
    {
        var latitudeDifference = endPoint.latitude - startPoint.latitude;
        var longitudeDifference = endPoint.longitude - startPoint.longitude;
        var timeRatio = (currentTimeOffset - startPoint.timeOffset) / (endPoint.timeOffset - startPoint.timeOffset);
        var newPointLatitude = startPoint.latitude + latitudeDifference * timeRatio;
        var newPointLongitude = startPoint.longitude + longitudeDifference * timeRatio;
        return new google.maps.LatLng(newPointLatitude, newPointLongitude);
    }

    window.onload = function()
    {
        serverTime = new ServerTime();
        markerIcons = new MarkerIcons();

        var context = new Context(@Html.Raw(Json.Encode(@Model.BusStops)), @Html.Raw(Json.Encode(@Model.BusLines)));
        ko.applyBindings(context);

        map.addListener('click', function(e)
        {
            context.busStops.activeBusStop(null);
            context.busLines.selectedBusLine(null);
        });
    }
</script>